{% extends 'complaints/base.html' %}
{% load static %}

{% block title %}Technician Dashboard{% endblock %}

{% block content %}
  <h2 class="mb-4">Technician Dashboard</h2>

  <!-- Metrics row -->
  <div class="row mb-4">
    <div class="col-md-3">
      <div class="card text-white bg-primary">
        <div class="card-body text-center">
          <h5 class="card-title">Total Assigned</h5>
          <p class="display-6">{{ total }}</p>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card text-white bg-warning">
        <div class="card-body text-center">
          <h5 class="card-title">New</h5>
          <p class="display-6">{{ status_counts.new }}</p>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card text-white bg-info">
        <div class="card-body text-center">
          <h5 class="card-title">In Progress</h5>
          <p class="display-6">{{ status_counts.in_progress }}</p>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card text-white bg-success">
        <div class="card-body text-center">
          <h5 class="card-title">Closed</h5>
          <p class="display-6">{{ status_counts.closed }}</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Resolution times -->
  <div class="row mb-4">
    <div class="col-md-6">
      <div class="alert alert-secondary text-center">
        <strong>Avg. Resolution Time:</strong> {{ avg_resolution }} days
      </div>
    </div>
    <div class="col-md-6">
      <div class="alert alert-secondary text-center">
        <strong>Median Resolution Time:</strong> {{ median_resolution }} days
      </div>
    </div>
  </div>

  <!-- Include DataTables CSS -->
  <link
    rel="stylesheet"
    href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css"
  />

  <!-- Complaints table (scrollable) -->
  <div class="mb-4">
    <table
      id="tech-table"
      class="table table-striped table-bordered align-middle"
      style="width:100%"
    >
      <thead class="table-light">
        <tr>
          <th>ID</th>
          <th>Location</th>
          <th>Status</th>
          <th>Submitted</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody>
        {% for c in complaints %}
          <tr>
            <td>{{ c.id }}</td>
            <td>{{ c.location|truncatechars:30 }}</td>
            <td>{{ c.get_status_display }}</td>
            <td>{{ c.created_at|date:"Y-m-d H:i" }}</td>
            <td>
              {% if c.status != 'FIX' and c.status != 'CLO' %}
                <a
                  class="btn btn-sm btn-primary"
                  href="{% url 'complaints:complaint_update' c.id %}"
                >
                  Update
                </a>
              {% else %}
                <span class="text-muted">â€”</span>
              {% endif %}
            </td>
          </tr>
        {% empty %}
          <tr>
            <td colspan="5" class="text-center">No assigned complaints.</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- jQuery + DataTables JS -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
  <script>
    $(document).ready(function() {
      $('#tech-table').DataTable({
        scrollY: '400px',
        scrollCollapse: true,
        paging: false,
        order: [[0, 'desc']],
        language: {
          searchPlaceholder: "Search complaints..."
        }
      });
    });
  </script>
{% endblock %}
