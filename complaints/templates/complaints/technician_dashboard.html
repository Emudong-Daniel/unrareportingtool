<!-- complaints/technician_dashboard.html -->
{% extends 'complaints/base.html' %}

{% block title %}Technician Dashboard{% endblock %}

{% block content %}
<h2 class="mb-4">Technician Dashboard</h2>

<!-- Summary cards with links. "In Progress" blinks when count > 0 -->
<div class="row mb-4">
  <div class="col-md-4">
    <a href="{% url 'complaints:technician_dashboard' %}" class="text-decoration-none d-block">
      <div class="card text-white bg-primary mb-3">
        <div class="card-body text-center">
          <h5 class="card-title">Total Assigned</h5>
          <p class="display-6">{{ total }}</p>
        </div>
      </div>
    </a>
  </div>

  <div class="col-md-4">
    <a href="{% url 'complaints:technician_dashboard' %}?status=INP" class="text-decoration-none d-block">
      <div class="card text-white bg-info mb-3 {% if status_counts.in_progress %}blink-card{% endif %}">
        <div class="card-body text-center">
          <h5 class="card-title">In Progress</h5>
          <p class="display-6">{{ status_counts.in_progress }}</p>
        </div>
      </div>
    </a>
  </div>

  <div class="col-md-4">
    <a href="{% url 'complaints:technician_dashboard' %}?status=CLO" class="text-decoration-none d-block">
      <div class="card text-white bg-success mb-3">
        <div class="card-body text-center">
          <h5 class="card-title">Closed</h5>
          <p class="display-6">{{ status_counts.closed }}</p>
        </div>
      </div>
    </a>
  </div>
</div>

<!-- Applied filter hint -->
<div id="filter-hint" class="alert alert-info py-2 px-3 d-none"></div>

<!-- Resolution metrics -->
<div class="row mb-4">
  <div class="col-md-6">
    <div class="alert alert-secondary text-center">
      <strong>Average Resolution:</strong> {{ avg_resolution }} days
    </div>
  </div>
  <div class="col-md-6">
    <div class="alert alert-secondary text-center">
      <strong>Median Resolution:</strong> {{ median_resolution }} days
    </div>
  </div>
</div>

<!-- Assigned complaints table -->
<div class="table-responsive">
  <table class="table align-middle" id="tech-table">
    <thead>
      <tr>
        <th>ID</th>
        <th>Created</th>
        <th>Status</th>
        <th>Location</th>
        <th>Description</th>
        <th>Photo</th>
        <th>Update</th>
      </tr>
    </thead>
    <tbody>
      {% for c in complaints %}
      <tr data-status="{{ c.status }}" class="{% if c.status == 'INP' %}blink-row{% endif %}">
        <td>#{{ c.id }}</td>
        <td>{{ c.created_at|date:"Y-m-d H:i" }}</td>
        <td>
          {% if c.status == 'NEW' %}
            <span class="badge bg-warning text-dark">New</span>
          {% elif c.status == 'INP' %}
            <span class="badge bg-info text-dark">In Progress</span>
          {% elif c.status == 'FIX' %}
            <span class="badge bg-primary">Fixed</span>
          {% elif c.status == 'CLO' %}
            <span class="badge bg-success">Closed</span>
          {% else %}
            <span class="badge bg-secondary">{{ c.status }}</span>
          {% endif %}
        </td>
        <td>{{ c.location }}</td>
        <td class="text-truncate" style="max-width: 320px">{{ c.description }}</td>
        <td>
          {% if c.photo %}
            <a href="{{ c.photo.url }}" target="_blank" rel="noopener">View</a>
          {% else %}
            <span class="text-muted">None</span>
          {% endif %}
        </td>
        <td>
          <a href="{% url 'complaints:complaint_update' c.id %}" class="btn btn-sm btn-outline-primary">
            Update
          </a>
        </td>
      </tr>
      {% empty %}
      <tr>
        <td colspan="7" class="text-muted">No assigned complaints</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- Strong blink styles -->
<style>
@keyframes cardStrobe {
  0%, 49% { box-shadow: 0 0 0 0 rgba(255, 23, 68, 0), 0 0 0 0 rgba(255, 23, 68, 0) }
  50%, 100% { box-shadow: 0 0 0 4px #ffffff inset, 0 0 36px 8px rgba(255, 23, 68, 0.95) }
}
.blink-card {
  position: relative;
  animation: cardStrobe 1s infinite;
  border: 3px solid #ff1744 !important;
}
.blink-card::after {
  content: '';
  position: absolute;
  inset: -8px;
  border-radius: 0.75rem;
  border: 4px solid #ff1744;
  box-shadow: 0 0 24px 6px rgba(255, 23, 68, 0.85);
  animation: ringPulse 1.2s ease-in-out infinite;
  pointer-events: none;
}
@keyframes ringPulse {
  0% { opacity: 0.4; transform: scale(0.98) }
  50% { opacity: 1; transform: scale(1.02) }
  100% { opacity: 0.4; transform: scale(0.98) }
}

@keyframes rowStrobe {
  0%, 49% { background-color: rgba(255, 235, 59, 0.45) }
  50%, 100% { background-color: rgba(255, 23, 68, 0.35) }
}
.blink-row {
  animation: rowStrobe 0.85s steps(2) infinite;
  border-left: 6px solid #ff1744;
}

.d-none { display: none }
</style>

<!-- Client side filter using the status query parameter -->
<script>
(function() {
  var params = new URLSearchParams(window.location.search)
  var status = params.get('status')
  if (!status) return

  var rows = document.querySelectorAll('#tech-table tbody tr')
  var shown = 0
  rows.forEach(function(row) {
    if (row.getAttribute('data-status') === status) {
      row.style.display = ''
      shown += 1
    } else {
      row.style.display = 'none'
    }
  })

  var labelMap = { NEW: 'New', INP: 'In Progress', FIX: 'Fixed', CLO: 'Closed' }
  var hint = document.getElementById('filter-hint')
  if (hint) {
    hint.classList.remove('d-none')
    hint.textContent = 'Filter applied: ' + (labelMap[status] || status) + ' â€” ' + shown + ' item(s)'
  }
})()
</script>
{% endblock %}
