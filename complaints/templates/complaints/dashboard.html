<!-- complaints/dashboard.html -->
{% extends 'complaints/base.html' %}
{% load static %}

{% block title %}Manager Metrics{% endblock %}

{% block content %}
  <h2 class="mb-4">Metrics Dashboard</h2>

  <!-- Summary cards -->
  <div class="row mb-4">
    <div class="col-md-3">
      <a href="{% url 'complaints:admin_dashboard' %}" class="text-decoration-none d-block">
        <div class="card text-white bg-primary mb-3">
          <div class="card-body text-center">
            <h5 class="card-title">Total Complaints</h5>
            <p class="display-6">{{ total }}</p>
          </div>
        </div>
      </a>
    </div>

    <div class="col-md-3">
      <a href="{% url 'complaints:admin_dashboard' %}?q=NEW" class="text-decoration-none d-block">
        <div class="card text-dark bg-warning mb-3 {% if breakdown.new|default:0 %}blink-card-warning{% endif %}">
          <div class="card-body text-center">
            <h5 class="card-title">New</h5>
            <p class="display-6">{{ breakdown.new }}</p>
          </div>
        </div>
      </a>
    </div>

    <div class="col-md-3">
      <a href="{% url 'complaints:admin_dashboard' %}?q=INP" class="text-decoration-none d-block">
        <div class="card text-white bg-info mb-3">
          <div class="card-body text-center">
            <h5 class="card-title">In Progress</h5>
            <p class="display-6">{{ breakdown.in_progress }}</p>
          </div>
        </div>
      </a>
    </div>

    <div class="col-md-3">
      <a href="{% url 'complaints:admin_dashboard' %}?q=CLO" class="text-decoration-none d-block">
        <div class="card text-white bg-success mb-3">
          <div class="card-body text-center">
            <h5 class="card-title">Closed</h5>
            <p class="display-6">{{ breakdown.closed }}</p>
          </div>
        </div>
      </a>
    </div>
  </div>

  <!-- Resolution times -->
  <div class="row mb-4">
    <div class="col-md-6">
      <div class="alert alert-secondary text-center">
        <strong>Average Resolution:</strong> {{ avg_resolution }} days
      </div>
    </div>
    <div class="col-md-6">
      <div class="alert alert-secondary text-center">
        <strong>Median Resolution:</strong> {{ median_resolution }} days
      </div>
    </div>
  </div>

  <!-- Monthly trends table -->
  <h4>Monthly Complaints</h4>
  <table id="monthly-table" class="table table-bordered mb-4" style="width:100%">
    <thead>
      <tr><th>Month</th><th>Count</th></tr>
    </thead>
    <tbody>
      {% for m in monthly %}
        <tr>
          <td>{{ m.month }}</td>
          <td>{{ m.count }}</td>
        </tr>
      {% endfor %}
    </tbody>
  </table>

  <!-- Top locations table -->
  <h4>Top 5 Locations</h4>
  <table id="toploc-table" class="table table-bordered" style="width:100%">
    <thead>
      <tr><th>Location</th><th>Count</th></tr>
    </thead>
    <tbody>
      {% for loc in top_locations %}
        <tr>
          <td>{{ loc.location }}</td>
          <td>{{ loc.count }}</td>
        </tr>
      {% endfor %}
    </tbody>
  </table>

  <!-- Strong blink styles for New card -->
  <style>
    @keyframes adminCardStrobe {
      0%, 49% { box-shadow: 0 0 0 0 rgba(255, 193, 7, 0), 0 0 0 0 rgba(255, 23, 68, 0) }
      50%, 100% { box-shadow: 0 0 0 4px #ffffff inset, 0 0 36px 8px rgba(255, 23, 68, 0.95) }
    }
    .blink-card-warning {
      position: relative;
      animation: adminCardStrobe 1s infinite;
      border: 3px solid #ff1744 !important;
    }
    .blink-card-warning::after {
      content: '';
      position: absolute;
      inset: -8px;
      border-radius: 0.75rem;
      border: 4px solid #ff1744;
      box-shadow: 0 0 24px 6px rgba(255, 23, 68, 0.85);
      animation: adminRingPulse 1.2s ease-in-out infinite;
      pointer-events: none;
    }
    @keyframes adminRingPulse {
      0% { opacity: 0.4; transform: scale(0.98) }
      50% { opacity: 1; transform: scale(1.02) }
      100% { opacity: 0.4; transform: scale(0.98) }
    }
  </style>

  <!-- DataTables assets -->
  <link
    rel="stylesheet"
    href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css"
  />
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
  <script>
    $(document).ready(function() {
      $('#monthly-table, #toploc-table').DataTable({
        scrollY: '300px',
        scrollCollapse: true,
        paging: false,
        ordering: true,
        info: false
      });
    });
  </script>
{% endblock %}
