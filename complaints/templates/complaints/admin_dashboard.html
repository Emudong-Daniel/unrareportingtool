{% extends 'complaints/base.html' %}
{% load static %}

{% block title %}Admin Dashboard{% endblock %}

{% block content %}
  <h2 class="mb-4">Admin Dashboard</h2>

  <table
    id="admin-table"
    class="table table-striped table-bordered align-middle"
    style="width:100%"
  >
    <thead class="table-light">
      <tr>
        <th>ID</th>
        <th>Photo</th>
        <th>Location</th>
        <th>Status</th>
        <th>Assign</th>
        <th>Update</th>
      </tr>
    </thead>
    <tbody>
      {% for c in complaints %}
        <tr>
          <td>{{ c.id }}</td>
          <td>
            {% if c.photo %}
              <a href="{{ c.photo.url }}" target="_blank">
                <img src="{{ c.photo.url }}" width="80" alt="Photo">
              </a>
            {% else %}
              —
            {% endif %}
          </td>
          <td>{{ c.location }}</td>
          <td>{{ c.get_status_display }}</td>
          <td>
            {% comment %}
              Only show the assign form if status is neither FIX nor CLO
            {% endcomment %}
            {% if c.status != 'FIX' and c.status != 'CLO' %}
              <form method="post" class="d-flex align-items-center">
                {% csrf_token %}
                <input type="hidden" name="complaint" value="{{ c.id }}">
                <select name="technician" class="form-select form-select-sm me-2">
                  {% for t in technicians %}
                    <option value="{{ t.id }}">{{ t.username }}</option>
                  {% endfor %}
                </select>
                <button class="btn btn-sm btn-success">Assign</button>
              </form>
            {% else %}
              <span class="badge bg-secondary">Locked</span>
            {% endif %}
          </td>
          <td>
            {% if c.status != 'FIX' and c.status != 'CLO' %}
              <a
                class="btn btn-sm btn-primary"
                href="{% url 'complaints:complaint_update' c.id %}"
              >
                Update
              </a>
            {% else %}
              <span class="text-muted">—</span>
            {% endif %}
          </td>
        </tr>
      {% empty %}
        <tr>
          <td colspan="6" class="text-center">No complaints found.</td>
        </tr>
      {% endfor %}
    </tbody>
  </table>

  <!-- DataTables -->
  <link
    rel="stylesheet"
    href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css"
  />
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
  <script>
    $(function() {
      $('#admin-table').DataTable({
        scrollY: '500px',
        scrollCollapse: true,
        paging: false,
        order: [[0, 'desc']],
        language: { searchPlaceholder: "Search…" }
      });
    });
  </script>
{% endblock %}
